<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>CUzeBox/Emscripten/Game-changer</title>
	</head>

	<body>

	<div id="output"></div>

		<script>
			// One object to rule them all!

		</script>
		<script>var APPOBJECTS_START = {};</script>
		<script name="cuzebox_minimal_html">
			var emulatorIframeIsReady=false;
		// 	var Module = {
		// 	// doNotCaptureKeyboard: true
		// 	// keyboardListeningElement : (function() { return parent.window.emu.vars.dom.view["emuCanvas"] })(),
		// 	// keyboardListeningElement : (function() { return parent.document.querySelector("#emscripten_iframe_container iframe") })(),

		// 	// Specifies which file the emulator should start.
		// 	"arguments" : [ parent.window.emu.vars.gameFile ],

		// 	// The Emscripten output canvas.
		// 	"canvas"    : (function() { return parent.window.emu.vars.dom.view["emuCanvas"] })(),

		// 	"preInit"   : [function(){
		// 	}],

		// 	// Load the files from the files list.
		// 	"preRun"    : [ function(){
		// 		var parentGameFiles            = parent.window.emu.vars.gameFiles;
		// 		var parentgameFilesDownloading = parent.window.emu.vars.gameFilesDownloading;

		// 		if(   parentgameFilesDownloading ) { throw new Error('DATA FULLY LOADED?: gameFilesDownloading: ' + parentgameFilesDownloading); }
		// 		if( ! parentGameFiles.length     ) { throw new Error('DATA MISSING: parentGameFiles. Length:    ' + parentGameFiles.length);     }

		// 		parentGameFiles.map(function(d,i,a){
		// 			try{ emu["FS"].createPreloadedFile('/', d.name , d.data , true, true); }
		// 			catch(e){
		// 				console.log("Error loading file!", d.name);
		// 				alert("Error loading file! " + d.name);
		// 			}
		// 		});
		// 		// console.log("Files have been loaded.");
		// 	}
		// 	// ,function(){ SDL_EMSCRIPTEN_KEYBOARD_ELEMENT = ""; }
		// 	],

		// 	"postRun"   : [ emuIsReady ],

	 //       "print": (function() {
	 //         //console.log("error", window.arguments, arguments);
	 //         //var element = document.getElementById('output');
	 //         //if (element) element.value = ''; // clear browser cache
	 //         //return function(text) {
	 //         //  if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
	 //         //  // These replacements are necessary if you render to raw HTML
	 //         //  //text = text.replace(/&/g, "&amp;");
	 //         //  //text = text.replace(/</g, "&lt;");
	 //         //  //text = text.replace(/>/g, "&gt;");
	 //         //  //text = text.replace('\n', '<br>', 'g');
	 //         //  console.log("here it is:", text);
	 //         //  if (element) {
	 //         //    element.value += text + "\n";
	 //         //    element.scrollTop = element.scrollHeight; // focus on bottom
	 //         //  }
	 //         //};
	 //       })(),
	 //       "printErr": function(text) {
	 //         if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
	 //         console.error(text);
	 //       }
		// };
			function _debug_displayCustomGlobals(justReturnObj=false){
				var customGlobals = {};
				var windowKeys = Object.keys(window);
				var START = (windowKeys).indexOf('APPOBJECTS_START') ;
				var END   = (windowKeys).indexOf('APPOBJECTS_END')   ;

				if(START==-1 || END == -1){
				console.log(
					'APPOBJECTS_START and/or APPOBJECTS_END were not found.\n'+
					'You must put them around the script files you bring in to your application.\n'
					);
				console.log('EXAMPLE USAGE:\n');
				console.log( "\<script\>var APPOBJECTS_START = {};  \</script\>" );
				console.log( "\<script src='js/YOUR_JS_SCRIPT1.js'\>\</script\>" );
				console.log( "\<script src='js/YOUR_JS_SCRIPT2.js'\>\</script\>" );
				console.log( "\<script\>var APPOBJECTS_END   = {};  \</script\>" );
				return;
				}

				for(var i=START+1; i<END; i++){ customGlobals[ windowKeys[i] ] = window[ windowKeys[i] ]; }

				if(!justReturnObj){
				// console.log("\n\n");
				console.log("*******************************************************************************************");
				console.log( "START  :", START , "\nEND    :", END ,"\nLENGTH :", END-START-1 ,	"");
				console.log("customGlobals:\n", customGlobals);
				console.log("*******************************************************************************************");
				// console.log("\n\n");
				customGlobals = {};
				}
				else{
				return customGlobals;
				}
			}
			function resizeIframe(){
				var canvas                = emu["canvas"];
				var parentIframeContainer = parent.document.querySelector("#emscripten_iframe_container");

				// Determine what the new width and height should be.
				var emuWidth  = parentIframeContainer.getBoundingClientRect().width  + "px";
				var emuHeight = parentIframeContainer.getBoundingClientRect().height + "px";

				// Set the new width and height of the Emscripten canvas and the parent iframe.
				canvas.style.width  = emuWidth  ;
				canvas.style.height = emuHeight ;
			};
			function emuIsReady(){
				console.log("Emulator is ready!", emu["arguments"]);

				emulatorIframeIsReady=true;
				parent.window.emu.vars.gameAllowedToLoad=true;
				resizeIframe();
			};

			// Handle the iframe resizing on certain key events.
			document.addEventListener("keydown", function(e){
				switch(e.code){
					// Emulator controls.
					case 'F2'  : { setTimeout(function(){ resizeIframe(); }, 25); break; }
					case 'F3'  : { setTimeout(function(){ resizeIframe(); }, 25); break; }
					default    : { setTimeout(function(){ }, 25); break; }
				}
			});
		</script>

		<!-- PLACE HOLDER FOR REPLACEMENT -->

		<script>
			// var gameFileArg="Tetris.uze";
			var emu = UOP({
				// Specifies which file the emulator should start.
				"arguments" : [ parent.window.emu.vars.gameFile ],
				// "arguments" : [ "Tetris.uze" ],
				// "arguments" : [ "TilesDemo.hex" ],
				// "arguments" : [ "RamTileTest_1.uze" ],
				// "arguments" : [ gameFileArg ],

				// The Emscripten output canvas.
				"canvas"    : (function() { return parent.window.emu.vars.dom.view["emuCanvas"] })(),

				"preInit"   : [function(){
				}],

				// Load the files from the files list.
				"preRun"    : [ function(){
					var parentGameFiles            = parent.window.emu.vars.gameFiles;
					var parentgameFilesDownloading = parent.window.emu.vars.gameFilesDownloading;

					if(   parentgameFilesDownloading ) { throw new Error('DATA NOT FULLY LOADED?: gameFilesDownloading   : ' + parentgameFilesDownloading); }
					if( ! parentGameFiles.length     ) { throw new Error('DATA MISSING          : parentGameFiles. Length: ' + parentGameFiles.length);     }

					parentGameFiles.map(function(d,i,a){
						try{ emu["FS"].createPreloadedFile('/', d.name , d.data , true, true); }
						catch(e){
							console.log("Error loading file!", d.name);
							alert("Error loading file! " + d.name);
						}
					});
				}
				],

				"postRun"   : [ emuIsReady ],

				"printErr": function(text) {
				  if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
				  console.error(text);
				}
			}
		);
		</script>

		<script>var APPOBJECTS_END = {};</script>
		<script>console.log(_debug_displayCustomGlobals());</script>

	</body>
</html>
