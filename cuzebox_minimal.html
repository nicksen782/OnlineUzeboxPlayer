<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>CUzeBox/Emscripten/Game-changer</title>
		<style>
			html{
				font-family: arial;
				padding    : 0px;
				margin     : 0px;
				overflow   : hidden;
			}
			body {
				margin  : 0px;
				padding : 0px;
				overflow: hidden;
			}
			div.emscripten{
				border  : 0px solid black;
				padding : 0px;
				margin  : 0px;
				display : block;
				overflow: hidden;
			}
			canvas.emscripten {
				border  : 0px solid black;
				padding : 0px;
				margin  : 0px;
				display : block;
				overflow: hidden;
			}
		</style>
	</head>

	<body>
		<div class="emscripten">
			<canvas class="emscripten" id="canvas"></canvas>
		</div>

		<script name="cuzebox_minimal_html">
			var emulatorIframeIsReady=false;
			var resizeIframe = function(){
				// Get DOM handles on the Emscripten canvas, the parent iframe and the parent iframe container.
				var canvas       = document.querySelector('#canvas');
				var parentIframe = parent.document.querySelector("#emscripten_iframe");
				var parentIframeContainer = parent.document.querySelector("#emscripten_iframe_container");

				// Determine what the new width and height should be.
				var emuWidth  = parentIframeContainer.getBoundingClientRect().width  + "px";
				var emuHeight = parentIframeContainer.getBoundingClientRect().height + "px";

				// Set the new width and height of the Emscripten canvas and the parent iframe.
				canvas      .style.width  = emuWidth  ;
				canvas      .style.height = emuHeight ;
				parentIframe.style.width  = emuWidth  ;
				parentIframe.style.height = emuHeight ;
			};
			var emuIsReady = function(){
				// console.log("Emulator is ready!");

				emulatorIframeIsReady=true;
				parent.window.emu.vars.gameAllowedToLoad=true;
				// parent.window.emu.vars.emu_displayStatus();

				// setTimeout(function(){
					resizeIframe();
				// }, 5);

				// Send a message to the parent.
				window.parent.postMessage(
					{
						'function': 'emuStarted',
						'data'    : [],
					}
					, document.location.href
				);
			};
			// Handle the iframe resizing on certain key events.
			document.addEventListener("keydown", function(e){
				switch(e.code){
					// Emulator controls.
					case 'F2'  : { setTimeout(function(){ resizeIframe(); }, 25); break; }
					case 'F3'  : { setTimeout(function(){ resizeIframe(); }, 25); break; }
					default    : { setTimeout(function(){ resizeIframe(); }, 25); break; }
				}
			});
			// Receive a message.
			window.addEventListener('message',function(e) {
				// console.log("postMessage listener");

				// Make sure the orgin domain is allowed.
				var allowed_domains = [
					"https://dev3-nicksen782.c9users.io",
					"https://www.nicksen782.net",
				];
				if (allowed_domains.indexOf(e.origin) == -1){
					console.log(
						"\n", "ERROR",
						"\n", e.origin,
						"\n", allowed_domains.indexOf(e.origin)
					);
					return;
				}

				console.log("Parent message:", e.data);

				switch(e.data.function){
					case 'keyToEmu' : {
						console.log("&&&&&&&&&&&");
						try{console.log("Emscripten iframe: keyToEmu:2", e.data);  } catch(e){ console.log("error2"); }
						try{console.log("Emscripten iframe: keyToEmu:3", e.data);  } catch(e){ console.log("error3"); }
						console.log("&&&&&&&&&&&");
						// var data = event.data.data;
						// // var e = new Event( data.type );
						// // var e = new Event( "keydown" );

						// var event1_obj = {
						// 	'shiftKey' : data.shiftKey ,
						// 	'location' : data.location ,
						// 	'code'     : data.code     ,
						// 	'key'      : data.key      ,
						// 	'keyCode'  : data.keyCode  ,
						// 	'which'    : data.which    ,
						// 	'altKey'   : data.altKey   ,
						// 	'ctrlKey'  : data.ctrlKey  ,
						// 	'metaKey'  : data.metaKey  ,
						// 	'bubbles'  : data.bubbles  ,
						// 	'type'     : data.type     ,
						// 	'isTrusted': true          ,
						// };
						// var event1 = new KeyboardEvent( event1_obj.type , event1_obj);

						// console.log("EMU:", event1);
						// window.dispatchEvent(event1);
						// document.dispatchEvent(event1);
						// document.body.dispatchEvent(event1);
						// document.body.querySelector("#canvas").dispatchEvent(event1);
						// Module['canvas'].dispatchEvent(event1);
						// parent.window.document.querySelector("#emscripten_iframe").contentWindow.dispatchEvent(event1);
						// parent.window.document.querySelector("#emscripten_iframe").contentDocument.dispatchEvent(event1);
						// parent.window.document.querySelector("#emscripten_iframe").dispatchEvent(event1);
						// console.log("EMU:", event1);

						break;
					}
					default : { console.log("Unexpected message.", event.data); break; }
				}

			}, false);

			// Emscripten config.
			var Module = {
				// Specifies which file the emulator should start.
				arguments : [ parent.window.emu.vars.gameFile ],

				// memoryInitializer : "nohkgjg",

				// The Emscripten output canvas.
				canvas    : (function() { return document.querySelector('#canvas'); })(),

				// Load the files from the files list.
				preInit   : [function(){
					// console.log("Loading files");

					// Retrieve the data from this iframe's parent.
					// var gameTitle                  = parent.window.emu.vars.gameTitle;
					// var currentgame                = parent.window.emu.vars.gameFile;
					// var uzerom                     = parent.window.emu.vars.gameFile;
					var parentGameFiles            = parent.window.emu.vars.gameFiles;
					var parentgameFilesDownloading = parent.window.emu.vars.gameFilesDownloading;

					if(   parentgameFilesDownloading ) { throw new Error('DATA FULLY LOADED?: gameFilesDownloading: ' + parentgameFilesDownloading); }
					// if( ! gameTitle.length           ) { throw new Error('DATA MISSING: gameTitle                   ' + gameTitle);                  }
					// if( ! currentgame.length         ) { throw new Error('DATA MISSING: currentgame                 ' + currentgame);                }
					// if( ! uzerom.length              ) { throw new Error('DATA MISSING: uzerom                      ' + uzerom);                     }
					if( ! parentGameFiles.length     ) { throw new Error('DATA MISSING: parentGameFiles. Length:    ' + parentGameFiles.length);     }

					parentGameFiles.map(function(d,i,a){
						try{ FS.createPreloadedFile('/', d.name , d.data , true, true); }
						catch(e){ console.log("Error loading file!", d.name); alert("Error loading file! " + d.name); }
					});

				}],

				preRun    : [ function(){
					// console.log("Files have been loaded.");
				}],

				postRun   : [ emuIsReady ],

				print     : (function() {
					// var element = document.querySelector('#output');
					// if (element) { element.value = ''; }// clear browser cache
					// return function(text) {
					// 	if (arguments.length > 1) { text = Array.prototype.slice.call(arguments).join(' '); }
					// 	// These replacements are necessary if you render to raw HTML
					// 	console.log("EMSCRIPTEN print:", text);
					// 	if (element) {
					// 		element.value += text + ' \n ';
					// 		element.scrollTop = element.scrollHeight; // focus on bottom
					// 	}
					// };
				})(),

				printErr  : function(text) {
					if (arguments.length > 1) { text = Array.prototype.slice.call(arguments).join(' '); }
					console.log("EMSCRIPTEN printErr:", text);
				},

			};

		</script>

		<!-- PLACE HOLDER FOR REPLACEMENT -->

	</body>
</html>
